# VitalTrack CI/CD Pipeline
# Builds, tests, and deploys backend and mobile app

name: Build and Deploy

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # =============================================================================
  # BACKEND TESTING
  # =============================================================================
  test-backend:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_DB: test_db
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          cd vitaltrack-backend
          pip install -r requirements.txt
          pip install pytest pytest-asyncio httpx
      
      - name: Run tests
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/test_db
          JWT_SECRET_KEY: test-secret-key-for-ci-testing-minimum-32-chars
          JWT_REFRESH_SECRET_KEY: test-refresh-secret-key-for-ci-testing-32chars
          ENVIRONMENT: testing
        run: |
          cd vitaltrack-backend
          # Run tests (create tests later)
          python -c "from app.main import app; print('App imports successfully')"
      
      - name: Run linting
        run: |
          cd vitaltrack-backend
          pip install ruff
          ruff check app/

  # =============================================================================
  # FRONTEND TESTING
  # =============================================================================
  test-frontend:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: vitaltrack-mobile/package-lock.json
      
      - name: Install dependencies
        run: |
          cd vitaltrack-mobile
          npm ci
      
      - name: Type check
        run: |
          cd vitaltrack-mobile
          npx tsc --noEmit
      
      - name: Lint check
        run: |
          cd vitaltrack-mobile
          npm run lint || true  # Don't fail on lint warnings for now

  # =============================================================================
  # BACKEND DEPLOYMENT (Railway)
  # =============================================================================
  deploy-backend:
    needs: [test-backend, test-frontend]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Deploy to Railway
        uses: railwayapp/deploy-action@v1
        with:
          railway_token: ${{ secrets.RAILWAY_TOKEN }}
          service: vitaltrack-api

  # =============================================================================
  # MOBILE BUILD (EAS)
  # =============================================================================
  build-mobile-preview:
    needs: [test-backend, test-frontend]
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Setup Expo
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}
      
      - name: Install dependencies
        run: |
          cd vitaltrack-mobile
          npm ci
      
      - name: Build Preview APK
        run: |
          cd vitaltrack-mobile
          eas build --profile preview --platform android --non-interactive

  build-mobile-production:
    needs: [test-backend, test-frontend]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Setup Expo
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}
      
      - name: Install dependencies
        run: |
          cd vitaltrack-mobile
          npm ci
      
      - name: Build Production AAB
        run: |
          cd vitaltrack-mobile
          eas build --profile production --platform android --non-interactive
      
      # Optional: Auto-submit to Play Store
      # - name: Submit to Play Store
      #   run: |
      #     cd vitaltrack-mobile
      #     eas submit --platform android --non-interactive
